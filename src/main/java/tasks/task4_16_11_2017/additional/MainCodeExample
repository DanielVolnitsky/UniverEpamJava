package tasks;


import org.json.JSONException;
import tasks.task4_16_11_2017.entities.CurrentConditionsDisplay;
import tasks.task4_16_11_2017.entities.Forecast;
import tasks.task4_16_11_2017.entities.LocationInfo;
import tasks.task4_16_11_2017.entities.WeatherData;
import tasks.task4_16_11_2017.entities.swing.ForecastFrame;
import tasks.task4_16_11_2017.exceptions.InvalidCoordinatesException;
import tasks.task4_16_11_2017.helpers.DarkSkyJsonDecoder;
import tasks.task4_16_11_2017.helpers.DarkSkyUrlMaker;
import tasks.task4_16_11_2017.helpers.DateHelper;
import tasks.task4_16_11_2017.helpers.JsonReader;

import javax.swing.*;
import java.util.Timer;
import java.util.TimerTask;

public class Main {

    static byte currHour;
    static LocationInfo locInfo;
    static WeatherData weatherData;

    public static void main(String[] args) throws JSONException {
        try {
            locInfo = new LocationInfo(
                    "Ukraine", "Kiev", 50.433304, 30.516693);

            final ForecastFrame frame = new ForecastFrame(
                    locInfo.getCountryName() + ", " + locInfo.getCity());

            weatherData = new WeatherData();

            CurrentConditionsDisplay ccDisplay = new CurrentConditionsDisplay(weatherData, frame.currWeatherArea);

            currHour = DateHelper.getCurrentHour();
            updatePrevDayValues(frame.prevWeatherArea, currHour);

            frame.setVisible(true);

            Timer t = new Timer();
            t.schedule(new TimerTask() {
                @Override
                public void run() {
                    updateCurrentValues();

                    byte newHour = DateHelper.getCurrentHour();
                    if (newHour != currHour) {
                        currHour = newHour;
                        updatePrevDayValues(frame.prevWeatherArea, currHour);
                    }
                }
            }, 0, 3000);

        } catch (InvalidCoordinatesException ex) {
            System.err.println(ex.getMessage());
        }
    }

    private static void updateCurrentValues() {
        try {
            JsonReader currReader = JsonReader.getDarkSkyJsonWithUrl(locInfo);
            DarkSkyJsonDecoder thisDayDecoder = new DarkSkyJsonDecoder(currReader.getJsonText());

            Forecast thisDayForecast = thisDayDecoder.getCurrentForecast();
            weatherData.setMeasurements(thisDayForecast);
        } catch (IllegalAccessException e) {
            System.err.println("Problems with identifying.");
        }
    }

    private static void updatePrevDayValues(JTextArea textArea, byte exactHour) {
        try {
            JsonReader yestReader = new JsonReader(DarkSkyUrlMaker.getUrl(locInfo, DateHelper.getYesterdayTime()));
            DarkSkyJsonDecoder prevDayDecoder = new DarkSkyJsonDecoder(yestReader.getJsonText());
            try {
                Forecast prevDayForecast = prevDayDecoder.getForecastForExactDay(exactHour);
                /*frame.prevWeatherArea*/
                textArea.setText(prevDayForecast.toString());
            } catch (JSONException e) {
                e.printStackTrace();
            }
        } catch (IllegalAccessException e) {
            System.err.println("Problems with identifying.");
        }
    }
}
